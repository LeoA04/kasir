<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart POS - Kasir Enterprise</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #3498db; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .product-card { 
            border: none; border-radius: 15px; transition: 0.3s; cursor: pointer; background: white;
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .product-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .cart-sticky { 
            position: sticky; top: 20px; background: white; border-radius: 20px; 
            padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 85vh;
        }
        .nav-pills .nav-link.active { background-color: var(--accent-color); }
        .btn-pay { background-color: #27ae60; border: none; font-weight: bold; padding: 12px; }
        .btn-pay:hover { background-color: #219150; }
        .history-table { background: white; border-radius: 15px; overflow: hidden; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container">
        <span class="navbar-brand fw-bold">üöÄ SMART POS SYSTEM</span>
        <div class="d-flex align-items-center">
            <span class="text-white me-3">Halo, <strong id="current-user">{{ user }}</strong></span>
            <a href="/logout" class="btn btn-outline-light btn-sm rounded-pill px-3">Keluar</a>
        </div>
    </div>
</nav>

<div class="container pb-5">
    <ul class="nav nav-pills mb-4 justify-content-center" id="mainTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#tab-kasir">üõí MENU KASIR</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#tab-history" onclick="loadHistory()">üìú HISTORI TRANSAKSI</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-kasir">
            <div class="row">
                <div class="col-lg-8">
                    <div class="mb-4">
                        <div class="input-group shadow-sm">
                            <input type="text" id="search-input" class="form-control form-control-lg border-0" 
                                   placeholder="üîç Cari menu..." onkeyup="filterProducts()">
                            <select id="category-filter" class="form-select border-0" style="max-width: 150px;" onchange="filterProducts()">
                                <option value="all">Semua</option>
                                <option value="makanan">üçî Makanan</option>
                                <option value="minuman">ü•§ Minuman</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-3" id="product-grid">
                        {% for id, p in products.items() %}
                        <div class="col-md-3 col-6 product-item" data-category="{{ p.category }}">
                            <div class="card product-card h-100 p-3 text-center" onclick="addToCart('{{ id }}')">
                                <div class="product-icon">{{ p.img }}</div>
                                <h6 class="fw-bold mb-1">{{ p.name }}</h6>
                                <p class="text-primary fw-bold mb-0">Rp {{ "{:,}".format(p.price) }}</p>
                                <small class="text-muted">{{ p.category.capitalize() }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="cart-sticky">
                        <h5 class="fw-bold border-bottom pb-3 mb-3">Detail Pesanan</h5>
                        <div id="cart-list" class="overflow-auto mb-3" style="max-height: 350px;">
                            <div class="text-center text-muted py-5">Keranjang Kosong</div>
                        </div>
                        <div class="border-top pt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Total Tagihan:</span>
                                <h4 class="fw-bold text-danger" id="cart-total">Rp 0</h4>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="promo-input" class="form-control form-control-sm mb-2" placeholder="Kode Promo">
                                <input type="number" id="cash-input" class="form-control form-control-lg fw-bold" placeholder="Jumlah Uang Tunai">
                            </div>
                            <button class="btn btn-success w-100 btn-pay" onclick="processCheckout()">KONFIRMASI PEMBAYARAN</button>
                            <div id="msg-area" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-history">
            <div class="card history-table shadow-sm border-0">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">Laporan Penjualan Terakhir</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Waktu Transaksi</th>
                                    <th>Total Bayar</th>
                                    <th>Diskon</th>
                                    <th>Kembalian</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="history-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function updateCartUI() {
        fetch('/api/cart')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('cart-list');
                const total = document.getElementById('cart-total');
                if (data.items.length === 0) {
                    list.innerHTML = '<div class="text-center text-muted py-5">Keranjang Kosong</div>';
                    total.innerText = 'Rp 0';
                    return;
                }
                list.innerHTML = data.items.map(item => `
                    <div class="d-flex justify-content-between align-items-center mb-3 bg-light p-2 rounded">
                        <div>
                            <div class="fw-bold small">${item.name}</div>
                            <div class="text-muted small">Rp ${item.price.toLocaleString()}</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-secondary py-0" onclick="reduceQty('${item.id}')">-</button>
                            <span class="mx-2 fw-bold">${item.quantity}</span>
                            <button class="btn btn-sm btn-outline-secondary py-0" onclick="addToCart('${item.id}')">+</button>
                        </div>
                    </div>
                `).join('');
                total.innerText = 'Rp ' + data.total.toLocaleString();
            });
    }

    function addToCart(id) {
        fetch('/api/cart/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({product_id: id})
        }).then(() => {
            updateCartUI();
            document.getElementById('msg-area').innerHTML = '';
        });
    }

    function reduceQty(id) {
        fetch('/api/cart/reduce', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({product_id: id})
        }).then(() => updateCartUI());
    }

    // --- UPDATE FUNGSI FILTER ---
    function filterProducts() {
        const searchText = document.getElementById('search-input').value.toLowerCase();
        const selectedCategory = document.getElementById('category-filter').value;
        const items = document.getElementsByClassName('product-item');
        
        for (let item of items) {
            const productName = item.innerText.toLowerCase();
            const itemCategory = item.getAttribute('data-category');
            
            const matchesSearch = productName.includes(searchText);
            const matchesCategory = (selectedCategory === "all") || (itemCategory === selectedCategory);
            
            item.style.display = (matchesSearch && matchesCategory) ? "block" : "none";
        }
    }

    function processCheckout() {
        const cash = document.getElementById('cash-input').value;
        const promo = document.getElementById('promo-input').value;
        const msg = document.getElementById('msg-area');

        fetch('/api/checkout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ amount_paid: parseInt(cash), promo_code: promo })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "SUCCESS") {
                msg.innerHTML = `<div class="alert alert-success"><b>Berhasil!</b><br>Kembalian: Rp ${data.change.toLocaleString()}</div>`;
                document.getElementById('cash-input').value = '';
                document.getElementById('promo-input').value = '';
                updateCartUI();
            } else {
                msg.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
            }
        });
    }

    function loadHistory() {
        fetch('/api/history')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('history-list');
                if (data.length === 0) {
                    list.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Belum ada transaksi</td></tr>';
                    return;
                }
                list.innerHTML = data.map(t => `
                    <tr>
                        <td>${t.time}</td>
                        <td class="fw-bold">Rp ${t.total.toLocaleString()}</td>
                        <td class="text-success small">- Rp ${t.discount ? t.discount.toLocaleString() : 0}</td>
                        <td class="text-primary">Rp ${t.change.toLocaleString()}</td>
                        <td><span class="badge bg-success">Selesai</span></td>
                    </tr>
                `).join('');
            });
    }

    updateCartUI();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>