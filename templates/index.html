<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Smart POS - Kasir Enterprise</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; }
        body { background-color: #f4f7f6; }
        .product-card { border: none; border-radius: 15px; transition: 0.3s; cursor: pointer; background: white; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .cart-sticky { position: sticky; top: 20px; background: white; border-radius: 20px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 85vh; }
    </style>
</head>

<script>
    function confirmLogout() {
        if (confirm("Apakah Anda yakin ingin logout?")) {
            window.location.href = "/logout";
        }
    }
</script>

<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand fw-bold">üöÄ SMART POS SYSTEM</span>
        <span class="text-white">Halo, <b>{{ user }}</b> | <a href="#" class="btn btn-sm btn-outline-danger" onclick="confirmLogout()">Keluar</a>
</span>
    </div>
</nav>

<div class="container pb-5">
    <ul class="nav nav-pills mb-4 justify-content-center" id="mainTab">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-kasir">üõçÔ∏è MENU KASIR</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-history" onclick="loadHistory()">üìú HISTORI TRANSAKSI</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-kasir">
            <div class="row">
                <div class="col-lg-8">
                    <div class="mb-4">
                        <div class="input-group shadow-sm">
                            <input type="text" id="search-input" class="form-control form-control-lg border-0" placeholder="üîç Cari menu..." onkeyup="filterProducts()">
                        </div>
                    </div>

                    <div class="row g-3" id="product-grid">
                        {% for p in products %}
                        <div class="col-md-3 col-6 product-item">
                            <div class="card product-card h-100 p-3 text-center" onclick="addToCart('{{ p.id }}')">
                                <div style="font-size: 2.5rem;">{{ p.img }}</div>
                                <h6 class="fw-bold mb-1">{{ p.name }}</h6>
                                <p class="text-primary fw-bold mb-0">Rp {{ "{:,}".format(p.price) }}</p>
                                <small class="text-muted">Stok: {{ p.stock }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="cart-sticky">
                        <h5 class="fw-bold border-bottom pb-3 mb-3">Detail Pesanan</h5>
                        <div id="cart-list" class="mb-3" style="max-height: 300px; overflow-y: auto;"></div>
                        
                        <div class="border-top pt-3">
                            <div class="mb-3">
                                <label class="small text-muted">Pilih Promo:</label>
                                <select id="promo-select" class="form-select form-select-sm" onchange="calculateTotal()">
                                    <option value="">Tanpa Promo</option>
                                </select>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Subtotal:</span>
                                <span id="subtotal-val">Rp 0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="fw-bold">Total Akhir:</span>
                                <h4 class="fw-bold text-danger" id="final-total">Rp 0</h4>
                            </div>
                            <input type="number" id="cash-input" class="form-control mb-3" placeholder="Masukkan Uang Tunai">
                            <button class="btn btn-success w-100 py-3 fw-bold" onclick="processCheckout()">KONFIRMASI BAYAR</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-history">
            <div class="card shadow-sm border-0 p-4">
                <h5 class="fw-bold mb-4">Riwayat Belanja Anda</h5>
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Waktu</th>
                                <th>Subtotal</th>
                                <th>Promo</th>
                                <th>Total Akhir</th>
                                <th>Bayar</th>
                                <th>Kembali</th>
                            </tr>
                        </thead>
                        <tbody id="history-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentSubtotal = 0;

    function filterProducts() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const items = document.getElementsByClassName('product-item');
        for (let item of items) {
            item.style.display = item.innerText.toLowerCase().includes(query) ? "block" : "none";
        }
    }

    function updateCartUI() {
        fetch('/api/cart').then(res => res.json()).then(data => {
            const list = document.getElementById('cart-list');
            currentSubtotal = data.total;
            document.getElementById('subtotal-val').innerText = 'Rp ' + data.total.toLocaleString();
            if (!data.items.length) {
                list.innerHTML = '<div class="text-center text-muted py-5">Kosong</div>';
                calculateTotal(); return;
            }
            list.innerHTML = data.items.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-2 bg-light p-2 rounded">
                    <div class="small"><b>${item.name}</b><br>Rp ${item.price.toLocaleString()}</div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-sm btn-outline-danger py-0" onclick="changeQty('${item.id}', 'reduce')">-</button>
                        <span class="mx-2 fw-bold small">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-success py-0" onclick="changeQty('${item.id}', 'add')">+</button>
                    </div>
                </div>
            `).join('');
            calculateTotal();
        });
    }

    function changeQty(id, action) {
        const url = action === 'add' ? '/api/cart/add' : '/api/cart/reduce';
        fetch(url, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({product_id: id})}).then(() => updateCartUI());
    }

    function addToCart(id) { changeQty(id, 'add'); }

    function loadPromos() {
        fetch('/api/promos').then(res => res.json()).then(data => {
            const sel = document.getElementById('promo-select');
            data.forEach(p => {
                let opt = document.createElement('option');
                opt.value = p.code; opt.dataset.disc = p.discount;
                opt.innerText = `${p.code} (Diskon ${p.discount}%)`;
                sel.appendChild(opt);
            });
        });
    }

    function calculateTotal() {
        const sel = document.getElementById('promo-select');
        const discPercent = sel.options[sel.selectedIndex].dataset.disc || 0;
        const final = currentSubtotal - (currentSubtotal * (discPercent / 100));
        document.getElementById('final-total').innerText = 'Rp ' + final.toLocaleString();
    }

    function processCheckout() {
        const cash = document.getElementById('cash-input').value;
        const promo = document.getElementById('promo-select').value;
        fetch('/api/checkout', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({amount_paid: cash, promo_code: promo})})
        .then(res => res.json()).then(data => {
            if(data.status === "SUCCESS") { alert(`Berhasil! Kembalian: Rp ${data.change.toLocaleString()}`); location.reload(); }
            else alert(data.message);
        });
    }

    function loadHistory() {
        fetch('/api/history').then(res => res.json()).then(data => {
            const list = document.getElementById('history-list');
            list.innerHTML = data.map(t => `
                <tr>
                    <td>${t.time}</td>
                    <td>Rp ${t.subtotal.toLocaleString()}</td>
                    <td class="text-success">${t.promo}</td>
                    <td class="fw-bold">Rp ${t.total.toLocaleString()}</td>
                    <td>Rp ${t.paid.toLocaleString()}</td>
                    <td class="text-primary">Rp ${t.change.toLocaleString()}</td>
                </tr>`).join('');
        });
    }

    updateCartUI(); loadPromos();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>